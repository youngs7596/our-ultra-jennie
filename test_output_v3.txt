============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0
rootdir: /home/youngs75/projects/my-ultra-jennie
plugins: anyio-4.12.0, langsmith-0.4.56, asyncio-1.3.0, mock-3.15.1, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 22 items

tests/shared/test_llm_brain.py .....FF...FFF.F...FFFF                    [100%]

=================================== FAILURES ===================================
_______________ TestGetJenniesDecision.test_provider_none_error ________________

self = <test_llm_brain.TestGetJenniesDecision object at 0x7eb02f9d5c10>
sample_stock_info = {'code': '005930', 'market_cap': 400000000, 'name': '삼성전자', 'pbr': 1.2, ...}

    def test_provider_none_error(self, sample_stock_info):
        """Provider가 None인 경우"""
        from shared.llm import JennieBrain
    
        brain = object.__new__(JennieBrain)
        brain.provider = None
    
        result = brain.get_jennies_decision('BUY_MR', sample_stock_info)
    
        assert result['decision'] == 'REJECT'
>       assert '초기화 실패' in result['reason']
E       assert '초기화 실패' in "System Error: OpenAI LLM 호출 실패: Error code: 429 - {'error': {'message': 'You exceeded your current quota, please chec....com/docs/guides/error-codes/api-errors.', 'type': 'insufficient_quota', 'param': None, 'code': 'insufficient_quota'}}"

tests/shared/test_llm_brain.py:199: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  shared.llm_providers:llm_providers.py:412 ⚠️ [OpenAIProvider] 모델 'gpt-5-mini' 호출 실패: Error code: 429 - {'error': {'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, read the docs: https://platform.openai.com/docs/guides/error-codes/api-errors.', 'type': 'insufficient_quota', 'param': None, 'code': 'insufficient_quota'}}
ERROR    shared.llm:llm.py:116 ❌ [JennieBrain] 결재 중 오류: OpenAI LLM 호출 실패: Error code: 429 - {'error': {'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, read the docs: https://platform.openai.com/docs/guides/error-codes/api-errors.', 'type': 'insufficient_quota', 'param': None, 'code': 'insufficient_quota'}}
________________ TestGetJenniesDecision.test_llm_error_handling ________________

self = <test_llm_brain.TestGetJenniesDecision object at 0x7eb02f9d5fa0>
mock_brain = <shared.llm.JennieBrain object at 0x7eafceae6c30>
sample_stock_info = {'code': '005930', 'market_cap': 400000000, 'name': '삼성전자', 'pbr': 1.2, ...}

    def test_llm_error_handling(self, mock_brain, sample_stock_info):
        """LLM 호출 에러 핸들링"""
        mock_brain.provider.generate_json.side_effect = Exception("API Timeout")
    
        result = mock_brain.get_jennies_decision(
            'BUY_MR',
            sample_stock_info,
            buy_signal_type='BB_LOWER'
        )
    
        assert result['decision'] == 'REJECT'
>       assert 'LLM 결재 오류' in result['reason']
E       AssertionError: assert 'LLM 결재 오류' in 'System Error: API Timeout'

tests/shared/test_llm_brain.py:212: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    shared.llm:llm.py:116 ❌ [JennieBrain] 결재 중 오류: API Timeout
____________ TestAnalyzeNewsSentiment.test_sentiment_provider_none _____________

self = <test_llm_brain.TestAnalyzeNewsSentiment object at 0x7eb02f9d6db0>

>   ???
E   AssertionError: assert ('미초기화' in '분석 실패 (Local+Cloud): Ollama timed out after 60s' or '기본값' in '분석 실패 (Local+Cloud): Ollama timed out after 60s')

tests/shared/test_llm_brain.py:279: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  shared.llm_providers:llm_providers.py:125 ⚠️ [Ollama] Timeout (60s) on attempt 1/3
WARNING  shared.llm_providers:llm_providers.py:125 ⚠️ [Ollama] Timeout (60s) on attempt 2/3
WARNING  shared.llm_providers:llm_providers.py:125 ⚠️ [Ollama] Timeout (60s) on attempt 3/3
ERROR    shared.llm_providers:llm_providers.py:178 ❌ [Ollama] generate_json failed: Ollama timed out after 60s
WARNING  shared.llm:llm.py:143 ⚠️ [News] Local LLM failed: Ollama timed out after 60s. Attempting Cloud Fallback...
WARNING  shared.llm_providers:llm_providers.py:412 ⚠️ [OpenAIProvider] 모델 'gpt-5-mini' 호출 실패: Error code: 429 - {'error': {'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, read the docs: https://platform.openai.com/docs/guides/error-codes/api-errors.', 'type': 'insufficient_quota', 'param': None, 'code': 'insufficient_quota'}}
ERROR    shared.llm:llm.py:155 ❌ [News] Fallback failed: OpenAI LLM 호출 실패: Error code: 429 - {'error': {'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, read the docs: https://platform.openai.com/docs/guides/error-codes/api-errors.', 'type': 'insufficient_quota', 'param': None, 'code': 'insufficient_quota'}}
_______________ TestRunDebateSession.test_debate_session_openai ________________

self = <test_llm_brain.TestRunDebateSession object at 0x7eb02f9d71a0>
mock_brain = <shared.llm.JennieBrain object at 0x7eafceb67f50>
sample_stock_info = {'code': '005930', 'market_cap': 400000000, 'name': '삼성전자', 'news_reason': 'AI 반도체 호재', ...}

>   ???
E   assert 'Bull' in "<MagicMock name='mock.generate_chat()' id='139293552595392'>"

tests/shared/test_llm_brain.py:300: AssertionError
___________ TestRunDebateSession.test_debate_session_gemini_fallback ___________

self = <test_llm_brain.TestRunDebateSession object at 0x7eb02f9d7560>
mock_brain = <shared.llm.JennieBrain object at 0x7eafcebc0260>
sample_stock_info = {'code': '005930', 'market_cap': 400000000, 'name': '삼성전자', 'news_reason': 'Test news', ...}

>   ???
E   assert "<MagicMock n...93552716320'>" == 'Gemini Debate Log'
E     
E     - Gemini Debate Log
E     + <MagicMock name='mock.generate_chat()' id='139293552716320'>

tests/shared/test_llm_brain.py:314: AssertionError
________________ TestRunJudgeScoring.test_judge_scoring_openai _________________

self = <test_llm_brain.TestRunJudgeScoring object at 0x7eb02f9d7d10>
mock_brain = <shared.llm.JennieBrain object at 0x7eafce9d89e0>
sample_stock_info = {'code': '005930', 'market_cap': 400000000, 'name': '삼성전자', 'news_reason': 'Good news', ...}

>   ???
E   AssertionError: assert <MagicMock name='mock.generate_json().__getitem__()' id='139293552761920'> == 75

tests/shared/test_llm_brain.py:350: AssertionError
_____________ TestV5HybridScoring.test_judge_scoring_v5_with_quant _____________

self = <test_llm_brain.TestV5HybridScoring object at 0x7eb02f9d60f0>
mock_brain = <shared.llm.JennieBrain object at 0x7eafcebaaf60>
sample_stock_info = {'code': '005930', 'market_cap': 400000000, 'name': '삼성전자', 'news_reason': 'News', ...}

>   ???
E   assert 0 == 82

tests/shared/test_llm_brain.py:418: AssertionError
________________ TestVerifyParameterChange.test_verify_approved ________________

self = <test_llm_brain.TestVerifyParameterChange object at 0x7eb02f9d5b20>
mock_brain = <shared.llm.JennieBrain object at 0x7eafceb64140>

>   ???
E   TypeError: JennieBrain.verify_parameter_change() takes 5 positional arguments but 6 were given

tests/shared/test_llm_brain.py:442: TypeError
________________ TestVerifyParameterChange.test_verify_rejected ________________

self = <test_llm_brain.TestVerifyParameterChange object at 0x7eb02f9d4f50>
mock_brain = <shared.llm.JennieBrain object at 0x7eafceb4fce0>

>   ???
E   TypeError: JennieBrain.verify_parameter_change() takes 5 positional arguments but 6 were given

tests/shared/test_llm_brain.py:462: TypeError
_____________ TestVerifyParameterChange.test_verify_provider_none ______________

self = <test_llm_brain.TestVerifyParameterChange object at 0x7eb02f9f0200>

>   ???
E   TypeError: JennieBrain.verify_parameter_change() takes 5 positional arguments but 6 were given

tests/shared/test_llm_brain.py:475: TypeError
=========================== short test summary info ============================
FAILED tests/shared/test_llm_brain.py::TestGetJenniesDecision::test_provider_none_error
FAILED tests/shared/test_llm_brain.py::TestGetJenniesDecision::test_llm_error_handling
FAILED tests/shared/test_llm_brain.py::TestAnalyzeNewsSentiment::test_sentiment_provider_none
FAILED tests/shared/test_llm_brain.py::TestRunDebateSession::test_debate_session_openai
FAILED tests/shared/test_llm_brain.py::TestRunDebateSession::test_debate_session_gemini_fallback
FAILED tests/shared/test_llm_brain.py::TestRunJudgeScoring::test_judge_scoring_openai
FAILED tests/shared/test_llm_brain.py::TestV5HybridScoring::test_judge_scoring_v5_with_quant
FAILED tests/shared/test_llm_brain.py::TestVerifyParameterChange::test_verify_approved
FAILED tests/shared/test_llm_brain.py::TestVerifyParameterChange::test_verify_rejected
FAILED tests/shared/test_llm_brain.py::TestVerifyParameterChange::test_verify_provider_none
================== 10 failed, 12 passed in 561.61s (0:09:21) ===================
