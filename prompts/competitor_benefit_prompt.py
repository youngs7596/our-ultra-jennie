"""
prompts/competitor_benefit_prompt.py - ê²½ìŸì‚¬ ìˆ˜í˜œ ë¶„ì„ í”„ë¡¬í”„íŠ¸
=============================================================

ì´ ëª¨ë“ˆì€ ê²½ìŸì‚¬ ì•…ì¬ ë°œìƒ ì‹œ ë°˜ì‚¬ì´ìµ ì¢…ëª©ì„ ë¶„ì„í•˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

í•µì‹¬ ì•„ì´ë””ì–´:
------------
Aê¸°ì—… ì•…ì¬ â†’ Bê¸°ì—…(ê²½ìŸì‚¬) í˜¸ì¬
ì˜ˆ: ì¿ íŒ¡ ê°œì¸ì •ë³´ ìœ ì¶œ â†’ ë„¤ì´ë²„/ì»¬ë¦¬ ìˆ˜í˜œ

ì„¹í„° ì •ì˜ (COMPETITOR_GROUPS):
----------------------------
- ECOMMERCE: ì´ì»¤ë¨¸ìŠ¤ (ì¿ íŒ¡, ë„¤ì´ë²„, ì»¬ë¦¬ ë“±)
- SEMICONDUCTOR: ë°˜ë„ì²´ (ì‚¼ì„±ì „ì, SKí•˜ì´ë‹‰ìŠ¤ ë“±)
- AUTO: ìë™ì°¨ (í˜„ëŒ€ì°¨, ê¸°ì•„, í…ŒìŠ¬ë¼ ë“±)
- FINANCE: ê¸ˆìœµ (KBê¸ˆìœµ, ì‹ í•œì§€ì£¼ ë“±)
- TELECOM: í†µì‹  (SKí…”ë ˆì½¤, KT, LGìœ í”ŒëŸ¬ìŠ¤)
- PLATFORM: í”Œë«í¼ (ì¹´ì¹´ì˜¤, ë„¤ì´ë²„, ë°°ë¯¼ ë“±)
- BATTERY: ë°°í„°ë¦¬ (LGì—ë„ˆì§€ì†”ë£¨ì…˜, ì‚¼ì„±SDI ë“±)

ì´ë²¤íŠ¸ ìœ í˜• (EVENT_IMPACT_RULES):
-------------------------------
- SECURITY_BREACH: ë³´ì•ˆì‚¬ê³  (í•´í‚¹, ê°œì¸ì •ë³´ ìœ ì¶œ)
- SERVICE_OUTAGE: ì„œë¹„ìŠ¤ ì¥ì• 
- RECALL: ì œí’ˆ ë¦¬ì½œ
- OWNER_RISK: ì˜¤ë„ˆ ë¦¬ìŠ¤í¬ (êµ¬ì†, íš¡ë ¹)
- REGULATION: ê·œì œ (ê³¼ì§•ê¸ˆ, ì œì¬)
"""

from __future__ import annotations
from typing import Dict, List, Optional
from textwrap import dedent


# ============================================================================
# ì„¹í„°ë³„ ê²½ìŸ ê´€ê³„ ì •ì˜ (Claude ì œì•ˆ + GPT í™•ì¥)
# ============================================================================

COMPETITOR_GROUPS = {
    # ì´ì»¤ë¨¸ìŠ¤
    'ECOMMERCE': {
        'name': 'ì´ì»¤ë¨¸ìŠ¤',
        'companies': ['ì¿ íŒ¡', 'ë„¤ì´ë²„', 'ì»¬ë¦¬', 'SSG', '11ë²ˆê°€', 'Gë§ˆì¼“', 'í‹°ëª¬', 'ìœ„ë©”í”„'],
        'stock_codes': {
            'ë„¤ì´ë²„': '035420',
            'NAVER': '035420',
            'ì‹ ì„¸ê³„': '004170',      # SSG ëª¨íšŒì‚¬
            'SSG': '004170',
            'ì»¬ë¦¬': '438210',
            'GSë¦¬í…Œì¼': '007070',    # GS SHOP
        },
        'notes': 'ì¿ íŒ¡ì€ ë¯¸êµ­ ìƒì¥(CPNG)ìœ¼ë¡œ í•œêµ­ ì‹œì¥ì— ì§ì ‘ ì˜í–¥ ì œí•œì '
    },
    
    # ë°˜ë„ì²´
    'SEMICONDUCTOR': {
        'name': 'ë°˜ë„ì²´',
        'companies': ['ì‚¼ì„±ì „ì', 'SKí•˜ì´ë‹‰ìŠ¤', 'ë§ˆì´í¬ë¡ ', 'TSMC'],
        'stock_codes': {
            'ì‚¼ì„±ì „ì': '005930',
            'SKí•˜ì´ë‹‰ìŠ¤': '000660',
        },
        'notes': 'ê¸€ë¡œë²Œ ê²½ìŸ êµ¬ë„, ë¯¸êµ­/ëŒ€ë§Œ ê¸°ì—… ì˜í–¥ ìˆìŒ'
    },
    
    # ë°°í„°ë¦¬/2ì°¨ì „ì§€
    'BATTERY': {
        'name': '2ì°¨ì „ì§€/ë°°í„°ë¦¬',
        'companies': ['LGì—ë„ˆì§€ì†”ë£¨ì…˜', 'ì‚¼ì„±SDI', 'SKì˜¨', 'CATL', 'íŒŒë‚˜ì†Œë‹‰'],
        'stock_codes': {
            'LGì—ë„ˆì§€ì†”ë£¨ì…˜': '373220',
            'ì‚¼ì„±SDI': '006400',
            'SKì´ë…¸ë² ì´ì…˜': '096770',  # SKì˜¨ ëª¨íšŒì‚¬
        },
        'notes': 'ì „ê¸°ì°¨ ë°°í„°ë¦¬ ì‹œì¥'
    },
    
    # ìë™ì°¨
    'AUTO': {
        'name': 'ìë™ì°¨',
        'companies': ['í˜„ëŒ€ì°¨', 'ê¸°ì•„', 'GMí•œêµ­', 'ë¥´ë…¸ì½”ë¦¬ì•„', 'ìŒìš©ì°¨'],
        'stock_codes': {
            'í˜„ëŒ€ì°¨': '005380',
            'í˜„ëŒ€ìë™ì°¨': '005380',
            'ê¸°ì•„': '000270',
        },
        'notes': 'êµ­ë‚´ ì™„ì„±ì°¨ ì‹œì¥'
    },
    
    # í†µì‹ 
    'TELECOM': {
        'name': 'í†µì‹ ',
        'companies': ['SKT', 'KT', 'LGU+'],
        'stock_codes': {
            'SKí…”ë ˆì½¤': '017670',
            'SKT': '017670',
            'KT': '030200',
            'LGìœ í”ŒëŸ¬ìŠ¤': '032640',
            'LGU+': '032640',
        },
        'notes': '3ì‚¬ ê³¼ì  ì‹œì¥'
    },
    
    # í•­ê³µ
    'AIRLINE': {
        'name': 'í•­ê³µ',
        'companies': ['ëŒ€í•œí•­ê³µ', 'ì•„ì‹œì•„ë‚˜', 'ì œì£¼í•­ê³µ', 'ì§„ì—ì–´', 'í‹°ì›¨ì´'],
        'stock_codes': {
            'ëŒ€í•œí•­ê³µ': '003490',
            'ì•„ì‹œì•„ë‚˜í•­ê³µ': '020560',
            'ì œì£¼í•­ê³µ': '089590',
            'ì§„ì—ì–´': '272450',
            'í‹°ì›¨ì´í•­ê³µ': '091810',
        },
        'notes': 'FSC vs LCC êµ¬ë„'
    },
    
    # ê²Œì„
    'GAME': {
        'name': 'ê²Œì„',
        'companies': ['í¬ë˜í”„í†¤', 'ì—”ì”¨ì†Œí”„íŠ¸', 'ë„·ë§ˆë¸”', 'ì¹´ì¹´ì˜¤ê²Œì„ì¦ˆ', 'í„ì–´ë¹„ìŠ¤'],
        'stock_codes': {
            'í¬ë˜í”„í†¤': '259960',
            'ì—”ì”¨ì†Œí”„íŠ¸': '036570',
            'ë„·ë§ˆë¸”': '251270',
            'ì¹´ì¹´ì˜¤ê²Œì„ì¦ˆ': '293490',
            'í„ì–´ë¹„ìŠ¤': '263750',
        },
        'notes': 'ëª¨ë°”ì¼/PC ê²Œì„'
    },
    
    # í”Œë«í¼/ITì„œë¹„ìŠ¤
    'PLATFORM': {
        'name': 'í”Œë«í¼/ITì„œë¹„ìŠ¤',
        'companies': ['ì¹´ì¹´ì˜¤', 'ë„¤ì´ë²„', 'ì¿ íŒ¡', 'ë°°ë‹¬ì˜ë¯¼ì¡±', 'í† ìŠ¤'],
        'stock_codes': {
            'ì¹´ì¹´ì˜¤': '035720',
            'ë„¤ì´ë²„': '035420',
            'ìš°ì•„í•œí˜•ì œë“¤': None,  # ë¹„ìƒì¥
        },
        'notes': 'ìŠˆí¼ì•± ê²½ìŸ'
    },
    
    # ê¸ˆìœµ/ì€í–‰
    'FINANCE': {
        'name': 'ê¸ˆìœµ/ì€í–‰',
        'companies': ['KBê¸ˆìœµ', 'ì‹ í•œì§€ì£¼', 'í•˜ë‚˜ê¸ˆìœµ', 'ìš°ë¦¬ê¸ˆìœµ', 'NHíˆ¬ì'],
        'stock_codes': {
            'KBê¸ˆìœµ': '105560',
            'ì‹ í•œì§€ì£¼': '055550',
            'í•˜ë‚˜ê¸ˆìœµì§€ì£¼': '086790',
            'ìš°ë¦¬ê¸ˆìœµì§€ì£¼': '316140',
        },
        'notes': '4ëŒ€ ê¸ˆìœµì§€ì£¼'
    },
    
    # ì—”í„°í…Œì¸ë¨¼íŠ¸
    'ENTERTAINMENT': {
        'name': 'ì—”í„°í…Œì¸ë¨¼íŠ¸',
        'companies': ['í•˜ì´ë¸Œ', 'SM', 'JYP', 'YG'],
        'stock_codes': {
            'í•˜ì´ë¸Œ': '352820',
            'SM': '041510',
            'JYP Ent.': '035900',
            'JYP': '035900',
            'YGì—”í„°': '122870',
        },
        'notes': 'K-POP 4ëŒ€ ê¸°íšì‚¬'
    },
    
    # ì œì•½/ë°”ì´ì˜¤
    'PHARMA': {
        'name': 'ì œì•½/ë°”ì´ì˜¤',
        'companies': ['ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', 'ì…€íŠ¸ë¦¬ì˜¨', 'ìœ í•œì–‘í–‰', 'SKë°”ì´ì˜¤íŒœ'],
        'stock_codes': {
            'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤': '207940',
            'ì…€íŠ¸ë¦¬ì˜¨': '068270',
            'ìœ í•œì–‘í–‰': '000100',
            'SKë°”ì´ì˜¤íŒœ': '326030',
        },
        'notes': 'ë°”ì´ì˜¤ì‹œë°€ëŸ¬/ì‹ ì•½'
    },
}


# ============================================================================
# ì´ë²¤íŠ¸ ì˜í–¥ë„ ê·œì¹™ (GPT ì œì•ˆ: ì¹´í…Œê³ ë¦¬ ì„¸ë¶„í™”)
# ============================================================================

EVENT_IMPACT_RULES = {
    # ë³´ì•ˆì‚¬ê³  (ì¿ íŒ¡ ì¼€ì´ìŠ¤)
    'ë³´ì•ˆì‚¬ê³ ': {
        'keywords': ['í•´í‚¹', 'ìœ ì¶œ', 'ê°œì¸ì •ë³´', 'ë³´ì•ˆ', 'ì¹¨í•´', 'ëœì„¬ì›¨ì–´', 'ì‚¬ì´ë²„ê³µê²©', 'ë°ì´í„°ìœ ì¶œ'],
        'victim_impact': -15,       # í”¼í•´ ê¸°ì—… ì ìˆ˜ ê°ì†Œ
        'competitor_benefit': +10,  # ê²½ìŸì‚¬ ê°€ì‚°ì 
        'duration_days': 20,        # ì˜í–¥ ì§€ì† ê¸°ê°„
        'confidence': 'HIGH',       # ë°˜ì‚¬ì´ìµ ì‹ ë¢°ë„
        'description': 'ê°œì¸ì •ë³´ ìœ ì¶œ, í•´í‚¹ ë“± ë³´ì•ˆì‚¬ê³ ëŠ” ì†Œë¹„ì ì‹ ë¢°ë¥¼ ì§ì ‘ í›¼ì†í•˜ì—¬ ê²½ìŸì‚¬ë¡œ ì´íƒˆ ìœ ë„'
    },
    
    # ì„œë¹„ìŠ¤ ì¥ì• 
    'ì„œë¹„ìŠ¤ì¥ì• ': {
        'keywords': ['ì¥ì• ', 'ë¨¹í†µ', 'ì ‘ì†ë¶ˆê°€', 'ì„œë²„ë‹¤ìš´', 'ì‹œìŠ¤í…œì˜¤ë¥˜', 'ì„œë¹„ìŠ¤ì¤‘ë‹¨'],
        'victim_impact': -10,
        'competitor_benefit': +8,
        'duration_days': 7,
        'confidence': 'HIGH',
        'description': 'ì„œë¹„ìŠ¤ ì¥ì•  ì‹œ ì‚¬ìš©ìë“¤ì˜ ì¦‰ê°ì ì¸ ëŒ€ì²´ ì„œë¹„ìŠ¤ ì´ìš©'
    },
    
    # ë¦¬ì½œ
    'ë¦¬ì½œ': {
        'keywords': ['ë¦¬ì½œ', 'ê²°í•¨', 'ë¶ˆëŸ‰', 'íšŒìˆ˜', 'í’ˆì§ˆë¬¸ì œ', 'í™”ì¬', 'ë°œí™”'],
        'victim_impact': -12,
        'competitor_benefit': +7,
        'duration_days': 30,
        'confidence': 'MEDIUM',
        'description': 'ëŒ€ê·œëª¨ ë¦¬ì½œì€ ë¸Œëœë“œ ì‹ ë¢°ë„ í•˜ë½, ê²½ìŸì‚¬ ì œí’ˆ ì„ í˜¸ ì¦ê°€'
    },
    
    # ì˜¤ë„ˆ ë¦¬ìŠ¤í¬
    'ì˜¤ë„ˆë¦¬ìŠ¤í¬': {
        'keywords': ['êµ¬ì†', 'ê¸°ì†Œ', 'íš¡ë ¹', 'ë°°ì„', 'ìˆ˜ì‚¬', 'ê²€ì°°', 'ì²´í¬', 'ì¬íŒ'],
        'victim_impact': -12,
        'competitor_benefit': +3,   # ë°˜ì‚¬ì´ìµ ë‚®ìŒ (ê²½ì˜ê³¼ ë³„ê°œë¡œ ë³¼ ìˆ˜ ìˆìŒ)
        'duration_days': 60,
        'confidence': 'LOW',
        'description': 'ì˜¤ë„ˆ ë¦¬ìŠ¤í¬ëŠ” ê²½ì˜ ì•ˆì •ì„± ìš°ë ¤ì§€ë§Œ ì§ì ‘ì ì¸ ëŒ€ì²´ íš¨ê³¼ëŠ” ì œí•œì '
    },
    
    # ê·œì œ/ê³¼ì§•ê¸ˆ
    'ê·œì œ': {
        'keywords': ['ê³¼ì§•ê¸ˆ', 'ì œì¬', 'ê·œì œ', 'ê³µì •ìœ„', 'ì‹œì •ëª…ë ¹', 'ë…ì ', 'ë‹´í•©'],
        'victim_impact': -8,
        'competitor_benefit': +5,
        'duration_days': 30,
        'confidence': 'MEDIUM',
        'description': 'ê·œì œëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸ ì œì•½ìœ¼ë¡œ ê²½ìŸì‚¬ì—ê²Œ ê¸°íšŒ'
    },
    
    # ì‹¤ì  ì‡¼í¬
    'ì‹¤ì ì•…í™”': {
        'keywords': ['ì–´ë‹ì‡¼í¬', 'ì‹¤ì ì•…í™”', 'ì ìì „í™˜', 'ë§¤ì¶œê¸‰ê°', 'ì˜ì—…ì†ì‹¤'],
        'victim_impact': -10,
        'competitor_benefit': +4,
        'duration_days': 20,
        'confidence': 'MEDIUM',
        'description': 'ì‹¤ì  ì•…í™”ëŠ” ì‹œì¥ ì ìœ ìœ¨ ë³€ë™ ê°€ëŠ¥ì„± ì‹œì‚¬'
    },
    
    # ë…¸ì‚¬ ë¶„ìŸ
    'ë…¸ì‚¬ë¶„ìŸ': {
        'keywords': ['íŒŒì—…', 'ë…¸ì¡°', 'ë…¸ì‚¬ê°ˆë“±', 'ìŸì˜', 'íƒœì—…'],
        'victim_impact': -7,
        'competitor_benefit': +5,
        'duration_days': 14,
        'confidence': 'MEDIUM',
        'description': 'íŒŒì—…ì€ ìƒì‚°/ì„œë¹„ìŠ¤ ì°¨ì§ˆë¡œ ê²½ìŸì‚¬ì— ì¼ì‹œì  ê¸°íšŒ'
    },
    
    # ESG/í™˜ê²½ ì´ìŠˆ
    'ESG': {
        'keywords': ['í™˜ê²½ì˜¤ì—¼', 'ESG', 'íƒ„ì†Œë°°ì¶œ', 'íìˆ˜', 'ìœ í•´ë¬¼ì§ˆ', 'ê°‘ì§ˆ', 'ì§ì¥ë‚´ê´´ë¡­í˜'],
        'victim_impact': -6,
        'competitor_benefit': +3,
        'duration_days': 30,
        'confidence': 'LOW',
        'description': 'ESG ì´ìŠˆëŠ” ì¥ê¸°ì  ë¸Œëœë“œ ì´ë¯¸ì§€ì— ì˜í–¥'
    },
}


# ============================================================================
# ê²½ìŸì‚¬ ìˆ˜í˜œ ë¶„ì„ í”„ë¡¬í”„íŠ¸ (Gemini ë°©ì‹: í•œ ì¤„ë¡œ ì‹œì‘)
# ============================================================================

COMPETITOR_BENEFIT_ANALYSIS_PROMPT = """
[ê²½ìŸì‚¬ ìˆ˜í˜œ ë¶„ì„ ì§€ì‹œ - v1.0]

ë‹¹ì‹ ì€ ì¢…ëª©ì„ ë¶„ì„í•  ë•Œ **ê²½ìŸì‚¬ ì•…ì¬ë¡œ ì¸í•œ ë°˜ì‚¬ì´ìµ**ë„ í•¨ê»˜ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.

## 1. ë¶„ì„ ëŒ€ìƒ ì•…ì¬ ìœ í˜•

ì•„ë˜ ìœ í˜•ì˜ ì•…ì¬ê°€ ê²½ìŸì‚¬ì—ê²Œ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”:

| ì•…ì¬ ìœ í˜• | í”¼í•´ ê¸°ì—… ì˜í–¥ | ê²½ìŸì‚¬ ìˆ˜í˜œ | ì§€ì† ê¸°ê°„ | ì‹ ë¢°ë„ |
|-----------|---------------|-------------|-----------|--------|
| ë³´ì•ˆì‚¬ê³ /í•´í‚¹ | -15ì  | +10ì  | D+20 | HIGH |
| ì„œë¹„ìŠ¤ì¥ì•  | -10ì  | +8ì  | D+7 | HIGH |
| ë¦¬ì½œ/í’ˆì§ˆë¬¸ì œ | -12ì  | +7ì  | D+30 | MEDIUM |
| ì˜¤ë„ˆë¦¬ìŠ¤í¬ | -12ì  | +3ì  | D+60 | LOW |
| ê·œì œ/ê³¼ì§•ê¸ˆ | -8ì  | +5ì  | D+30 | MEDIUM |
| ì‹¤ì ì•…í™” | -10ì  | +4ì  | D+20 | MEDIUM |

## 2. ì£¼ìš” ê²½ìŸ ê´€ê³„ (ì„¹í„°ë³„)

{competitor_groups_text}

## 3. íŒë‹¨ ê¸°ì¤€

ê²½ìŸì‚¬ì—ê²Œ ìœ„ ìœ í˜•ì˜ ì•…ì¬ê°€ ë°œìƒí•œ ê²½ìš°:
1. ë°˜ì‚¬ì´ìµ ê°€ì‚°ì ì„ ë¶€ì—¬í•˜ì„¸ìš” (ìœ„ í‘œ ì°¸ì¡°)
2. íŒë‹¨ ê·¼ê±°ì— "ê²½ìŸì‚¬ {íšŒì‚¬ëª…}ì˜ {ì•…ì¬ ìœ í˜•}ìœ¼ë¡œ ì¸í•œ ìˆ˜í˜œ ì˜ˆìƒ" ëª…ì‹œ
3. ì•…ì¬ì˜ ì‹ ë¢°ë„(HIGH/MEDIUM/LOW)ì— ë”°ë¼ ê°€ì‚°ì  ì¡°ì •

## 4. ì£¼ì˜ì‚¬í•­

âŒ ì œì™¸ ëŒ€ìƒ:
- ì‹œì¥ ì „ì²´ ì•…ì¬ (ê¸ˆë¦¬ ì¸ìƒ, í™˜ìœ¨ ë³€ë™, ì „ìŸ ë“±)
- í•´ë‹¹ ê¸°ì—…ë§Œì˜ ê³ ìœ  ì•…ì¬ê°€ ì•„ë‹Œ ì—…ì¢… ì „ì²´ ì´ìŠˆ
- ë¯¸êµ­/í•´ì™¸ ìƒì¥ ê¸°ì—…ì˜ ì•…ì¬ (í•œêµ­ ì‹œì¥ ì˜í–¥ ì œí•œì )

âœ… ì ìš© ëŒ€ìƒ:
- íŠ¹ì • ê¸°ì—…ì˜ ê³ ìœ  ì•…ì¬
- ì†Œë¹„ì ì‹ ë¢°/ë¸Œëœë“œ ì´ë¯¸ì§€ì— ì§ì ‘ ì˜í–¥ì„ ì£¼ëŠ” ì‚¬ê±´
- ì‹œì¥ ì ìœ ìœ¨ ë³€ë™ì´ ì˜ˆìƒë˜ëŠ” ì´ë²¤íŠ¸
"""


def build_competitor_groups_text() -> str:
    """ì„¹í„°ë³„ ê²½ìŸ ê´€ê³„ë¥¼ í…ìŠ¤íŠ¸ë¡œ í¬ë§·íŒ…"""
    lines = []
    for sector_code, sector_info in COMPETITOR_GROUPS.items():
        companies = ' â†” '.join(sector_info['companies'][:5])  # ìµœëŒ€ 5ê°œ
        lines.append(f"- {sector_info['name']}: {companies}")
    return '\n'.join(lines)


def get_competitor_benefit_prompt() -> str:
    """ê²½ìŸì‚¬ ìˆ˜í˜œ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ë°˜í™˜"""
    competitor_groups_text = build_competitor_groups_text()
    return COMPETITOR_BENEFIT_ANALYSIS_PROMPT.format(
        competitor_groups_text=competitor_groups_text
    )


# ============================================================================
# ê²½ìŸì‚¬ ì•…ì¬ ê°ì§€ í”„ë¡¬í”„íŠ¸ (ìƒì„¸ ë¶„ì„ìš©)
# ============================================================================

def build_competitor_event_detection_prompt(
    target_stock_code: str,
    target_stock_name: str,
    sector: str,
    recent_news: str,
) -> str:
    """
    íŠ¹ì • ì¢…ëª© ë¶„ì„ ì‹œ ê²½ìŸì‚¬ ì•…ì¬ ê°ì§€ë¥¼ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ìƒì„±
    
    Args:
        target_stock_code: ë¶„ì„ ëŒ€ìƒ ì¢…ëª© ì½”ë“œ
        target_stock_name: ë¶„ì„ ëŒ€ìƒ ì¢…ëª©ëª…
        sector: ì„¹í„° ì½”ë“œ (ECOMMERCE, SEMICONDUCTOR ë“±)
        recent_news: ìµœê·¼ ë‰´ìŠ¤ ìš”ì•½ (ê²½ìŸì‚¬ ë‰´ìŠ¤ í¬í•¨)
    
    Returns:
        ê²½ìŸì‚¬ ì•…ì¬ ê°ì§€ í”„ë¡¬í”„íŠ¸
    """
    sector_info = COMPETITOR_GROUPS.get(sector, {})
    competitors = sector_info.get('companies', [])
    
    # ì´ë²¤íŠ¸ í‚¤ì›Œë“œ ëª©ë¡ ìƒì„±
    all_keywords = []
    for event_type, event_info in EVENT_IMPACT_RULES.items():
        all_keywords.extend(event_info['keywords'])
    
    prompt = f"""
    [ê²½ìŸì‚¬ ì•…ì¬ ê°ì§€ ë¶„ì„]
    
    ë¶„ì„ ëŒ€ìƒ: {target_stock_name} ({target_stock_code})
    ì„¹í„°: {sector_info.get('name', sector)}
    ì£¼ìš” ê²½ìŸì‚¬: {', '.join(competitors[:5])}
    
    [ìµœê·¼ ë‰´ìŠ¤]
    {recent_news}
    
    [ë¶„ì„ ì§€ì‹œ]
    ìœ„ ë‰´ìŠ¤ì—ì„œ ê²½ìŸì‚¬({', '.join(competitors[:5])})ì˜ ì•…ì¬ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”.
    
    ì•…ì¬ í‚¤ì›Œë“œ: {', '.join(all_keywords[:20])}...
    
    [ì¶œë ¥ í˜•ì‹ - JSON]
    {{
        "competitor_events": [
            {{
                "company": "ê²½ìŸì‚¬ëª…",
                "event_type": "ë³´ì•ˆì‚¬ê³ |ì„œë¹„ìŠ¤ì¥ì• |ë¦¬ì½œ|ì˜¤ë„ˆë¦¬ìŠ¤í¬|ê·œì œ|ì‹¤ì ì•…í™”",
                "summary": "ì´ë²¤íŠ¸ ìš”ì•½ (1ë¬¸ì¥)",
                "severity": "HIGH|MEDIUM|LOW",
                "benefit_score": 0-10
            }}
        ],
        "total_benefit_score": 0-20,
        "analysis_reason": "ì¢…í•© ë¶„ì„ (2-3ë¬¸ì¥)"
    }}
    
    ê²½ìŸì‚¬ ì•…ì¬ê°€ ì—†ìœ¼ë©´ competitor_eventsë¥¼ ë¹ˆ ë°°ì—´ë¡œ, total_benefit_scoreë¥¼ 0ìœ¼ë¡œ ë°˜í™˜í•˜ì„¸ìš”.
    """
    
    return dedent(prompt).strip()


# ============================================================================
# ìˆ˜í˜œ ì¢…ëª© ì¶”ì²œ í”„ë¡¬í”„íŠ¸
# ============================================================================

def build_beneficiary_recommendation_prompt(
    event_company: str,
    event_type: str,
    event_summary: str,
    sector: str,
) -> str:
    """
    ì•…ì¬ ë°œìƒ ì‹œ ìˆ˜í˜œ ì¢…ëª© ì¶”ì²œ í”„ë¡¬í”„íŠ¸
    
    Args:
        event_company: ì•…ì¬ ë°œìƒ ê¸°ì—…
        event_type: ì•…ì¬ ìœ í˜•
        event_summary: ì•…ì¬ ìš”ì•½
        sector: ì„¹í„° ì½”ë“œ
    
    Returns:
        ìˆ˜í˜œ ì¢…ëª© ì¶”ì²œ í”„ë¡¬í”„íŠ¸
    """
    sector_info = COMPETITOR_GROUPS.get(sector, {})
    stock_codes = sector_info.get('stock_codes', {})
    event_rule = EVENT_IMPACT_RULES.get(event_type, {})
    
    prompt = f"""
    [ê²½ìŸì‚¬ ìˆ˜í˜œ ì¢…ëª© ë¶„ì„]
    
    ğŸ”´ í”¼í•´ ê¸°ì—…: {event_company}
    ğŸ“Œ ì´ë²¤íŠ¸: {event_type}
    ğŸ“‹ ìš”ì•½: {event_summary}
    
    [ì´ë²¤íŠ¸ ì˜í–¥ë„ ê·œì¹™]
    - í”¼í•´ ê¸°ì—… ì˜í–¥: {event_rule.get('victim_impact', -10)}ì 
    - ê²½ìŸì‚¬ ê¸°ë³¸ ìˆ˜í˜œ: {event_rule.get('competitor_benefit', +5)}ì 
    - ì˜ˆìƒ ì§€ì† ê¸°ê°„: D+{event_rule.get('duration_days', 20)}
    - í†µê³„ ì‹ ë¢°ë„: {event_rule.get('confidence', 'MEDIUM')}
    
    [ìˆ˜í˜œ í›„ë³´ (í•œêµ­ ìƒì¥)]
    {chr(10).join([f"- {name}: {code}" for name, code in stock_codes.items() if code])}
    
    [ë¶„ì„ ì§€ì‹œ]
    ìœ„ í›„ë³´ ì¤‘ì—ì„œ ê°€ì¥ í° ìˆ˜í˜œê°€ ì˜ˆìƒë˜ëŠ” ì¢…ëª©ì„ ì„ ì •í•˜ì„¸ìš”.
    
    ê³ ë ¤ ìš”ì†Œ:
    1. ì‹œì¥ ì ìœ ìœ¨ 2ìœ„ ê¸°ì—…ì´ ê°€ì¥ í° ìˆ˜í˜œ (ëŒ€ì²´ íš¨ê³¼)
    2. ì‚¬ì—… ì˜ì—­ ì¤‘ë³µë„ê°€ ë†’ì„ìˆ˜ë¡ ìˆ˜í˜œ ì¦ê°€
    3. ì´ë¯¸ ì£¼ê°€ê°€ ê¸‰ë“±í–ˆë‹¤ë©´ ìˆ˜í˜œ ê°ì†Œ (ì´ë¯¸ ë°˜ì˜)
    
    [ì¶œë ¥ í˜•ì‹ - JSON]
    {{
        "beneficiaries": [
            {{
                "stock_code": "ì¢…ëª©ì½”ë“œ",
                "stock_name": "ì¢…ëª©ëª…",
                "benefit_score": 0-100,
                "reason": "ìˆ˜í˜œ ì‚¬ìœ  (1ë¬¸ì¥)",
                "strategy": "ë§¤ìˆ˜ ì „ëµ (ì˜ˆ: RSI ê³¼ë§¤ë„ ì‹œ ë¶„í•  ë§¤ìˆ˜)"
            }}
        ],
        "top_pick": "ìµœìš°ì„  ì¶”ì²œ ì¢…ëª©ì½”ë“œ",
        "holding_period": "ê¶Œì¥ ë³´ìœ  ê¸°ê°„ (ì˜ˆ: D+20)",
        "risk_note": "ë¦¬ìŠ¤í¬ ì£¼ì˜ì‚¬í•­"
    }}
    """
    
    return dedent(prompt).strip()


# ============================================================================
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# ============================================================================

def detect_event_type_from_text(text: str) -> Optional[str]:
    """
    í…ìŠ¤íŠ¸ì—ì„œ ì´ë²¤íŠ¸ ìœ í˜• ê°ì§€
    
    Args:
        text: ë‰´ìŠ¤ ì œëª© ë˜ëŠ” ë³¸ë¬¸
    
    Returns:
        ê°ì§€ëœ ì´ë²¤íŠ¸ ìœ í˜• ë˜ëŠ” None
    """
    text_lower = text.lower()
    
    for event_type, event_info in EVENT_IMPACT_RULES.items():
        for keyword in event_info['keywords']:
            if keyword in text_lower:
                return event_type
    
    return None


def get_competitors_for_company(company_name: str) -> Dict:
    """
    íŠ¹ì • ê¸°ì—…ì˜ ê²½ìŸì‚¬ ì •ë³´ ë°˜í™˜
    
    Args:
        company_name: ê¸°ì—…ëª…
    
    Returns:
        {'sector': ì„¹í„°ì½”ë“œ, 'competitors': [ê²½ìŸì‚¬ ëª©ë¡], 'stock_codes': {ì¢…ëª©ì½”ë“œ}}
    """
    for sector_code, sector_info in COMPETITOR_GROUPS.items():
        if company_name in sector_info['companies']:
            return {
                'sector': sector_code,
                'sector_name': sector_info['name'],
                'competitors': [c for c in sector_info['companies'] if c != company_name],
                'stock_codes': sector_info['stock_codes'],
            }
    
    return {'sector': None, 'competitors': [], 'stock_codes': {}}


def calculate_competitor_benefit(event_type: str, confidence_multiplier: float = 1.0) -> int:
    """
    ì´ë²¤íŠ¸ ìœ í˜•ì— ë”°ë¥¸ ê²½ìŸì‚¬ ìˆ˜í˜œ ì ìˆ˜ ê³„ì‚°
    
    Args:
        event_type: ì´ë²¤íŠ¸ ìœ í˜•
        confidence_multiplier: ì‹ ë¢°ë„ ë³´ì • ê³„ìˆ˜ (0.5~1.5)
    
    Returns:
        ìˆ˜í˜œ ì ìˆ˜
    """
    event_rule = EVENT_IMPACT_RULES.get(event_type, {})
    base_benefit = event_rule.get('competitor_benefit', 0)
    
    # ì‹ ë¢°ë„ì— ë”°ë¥¸ ë³´ì •
    confidence = event_rule.get('confidence', 'MEDIUM')
    if confidence == 'HIGH':
        confidence_multiplier *= 1.2
    elif confidence == 'LOW':
        confidence_multiplier *= 0.7
    
    return int(base_benefit * confidence_multiplier)


# ============================================================================
# í…ŒìŠ¤íŠ¸ / ì˜ˆì‹œ
# ============================================================================

if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸: ê²½ìŸì‚¬ ìˆ˜í˜œ í”„ë¡¬í”„íŠ¸ ì¶œë ¥
    print("=" * 60)
    print("ê²½ìŸì‚¬ ìˆ˜í˜œ ë¶„ì„ í”„ë¡¬í”„íŠ¸")
    print("=" * 60)
    print(get_competitor_benefit_prompt())
    
    print("\n" + "=" * 60)
    print("ì¿ íŒ¡ ê°œì¸ì •ë³´ ìœ ì¶œ ì¼€ì´ìŠ¤")
    print("=" * 60)
    
    # í…ŒìŠ¤íŠ¸: ì¿ íŒ¡ ê²½ìŸì‚¬ ì¡°íšŒ
    coupang_competitors = get_competitors_for_company('ì¿ íŒ¡')
    print(f"ì¿ íŒ¡ì˜ ê²½ìŸì‚¬: {coupang_competitors}")
    
    # í…ŒìŠ¤íŠ¸: ì´ë²¤íŠ¸ ìœ í˜• ê°ì§€
    test_news = "ì¿ íŒ¡, 3370ë§Œëª… ê°œì¸ì •ë³´ ìœ ì¶œ ì‚¬ê³  ë°œìƒ"
    detected_event = detect_event_type_from_text(test_news)
    print(f"ê°ì§€ëœ ì´ë²¤íŠ¸: {detected_event}")
    
    # í…ŒìŠ¤íŠ¸: ìˆ˜í˜œ ì ìˆ˜ ê³„ì‚°
    benefit_score = calculate_competitor_benefit(detected_event)
    print(f"ê²½ìŸì‚¬ ìˆ˜í˜œ ì ìˆ˜: +{benefit_score}ì ")

